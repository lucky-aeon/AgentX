# Multi-Agent Messaging Design (Finalized)

This document aligns the final behavior for sub‑agent (child agent) messaging to eliminate duplication and keep the main timeline clean.

## Goals

- No duplicated answers on the main timeline when a sub‑agent is invoked.
- Keep UI consistent with tool calls: a single, typed record indicating a sub‑agent call.
- Preserve tracing/billing/metrics for the full chain, without persisting sub‑agent transcript as normal messages.

## Final Behavior

- Do not persist any messages generated by the sub‑agent (including its internal tool calls and the sub‑agent’s own assistant/user messages).
- Do not return sub‑agent transcript chunks to the frontend.
- Emit one SSE event to the main stream when invoking a sub‑agent:
  - `messageType`: `SUB_AGENT_CALL_START`
  - `content`: `子 Agent 调用：<agentName>`
  - `done`: `false` (may be `true` as well — UI does not rely on it)
- Do not emit `SUB_AGENT_PARTIAL`, `SUB_AGENT_COMPLETE`, or `SUB_AGENT_ERROR` to the main stream.
- The main agent resumes/continues its own response normally once sub‑agent invocation completes; no sub‑agent transcript is appended.

## Frontend (implemented)

- Render a single “子 Agent 调用” card with a robot icon when receiving `SUB_AGENT_CALL_START`.
- Display the content as the exact typed message string, e.g. `子 Agent 调用：文件助理`.
- Ignore `SUB_AGENT_PARTIAL`, `SUB_AGENT_COMPLETE`, and `SUB_AGENT_ERROR` if they ever appear.

Files updated in this repo:
- `components/chat-panel.tsx` — formats `SUB_AGENT_CALL_START` content, ignores others.
- `components/agent-preview-chat.tsx` — same handling in preview chat.

## Backend Changes (to implement in AgentX)

In brief: produce only the single `SUB_AGENT_CALL_START` event and suppress all sub‑agent transcript persistence/streaming.

- Where sub‑agent tool execution is orchestrated (e.g., `org.xhy.application.conversation.service.message.builtin.multiagent.MultiAgentBuiltInToolProvider`), update streaming logic to:
  1. Emit only one SSE record to the parent stream:
     - `messageType = SUB_AGENT_CALL_START`
     - `content = "子 Agent 调用：" + agentName`
     - Do not persist this record as a session message.
  2. Execute the sub‑agent and capture its final result internally (for the main agent to use), but:
     - Do not forward any sub‑agent transcript chunks.
     - Do not persist sub‑agent messages to the conversation.
  3. Do not emit `SUB_AGENT_PARTIAL`, `SUB_AGENT_COMPLETE`, `SUB_AGENT_ERROR` to the main stream.

- If earlier code persisted meta messages (e.g., “start” / “complete”), remove those calls (e.g., `persistAssistantMessage(...)`) from the sub‑agent path.

- Ensure `ChatContextHolder` (or equivalent) is still set for cross‑thread tool execution so tracing/billing works, but avoid creating conversation messages for the sub‑agent path.

Suggested touchpoints in AgentX (for reference):
- `AgentX/src/main/java/org/xhy/application/conversation/service/message/builtin/multiagent/MultiAgentBuiltInToolProvider.java` — emit only `SUB_AGENT_CALL_START` and return the sub‑agent’s result to the main agent logic without streaming.
- `AgentX/src/main/java/org/xhy/application/conversation/service/message/AbstractMessageHandler.java` — if there is a wrapper that previously forwarded nested SSE (`SUB_AGENT_*`) or persisted meta messages, remove those calls for the sub‑agent case.

## Tracing/Billing

- Keep metrics/tracing for the sub‑agent run (e.g., same trace context or a nested span), but logging should not create user‑visible messages.
- If needed, include a hidden `subRunId` for debug logs only; not part of the SSE to the UI.

## Rationale

- Prevents duplicated content where the sub‑agent answers, then the main agent restates the same text.
- Keeps the UI simple and focused: one visible indicator that a sub‑agent was invoked.
- Allows future expansion to expose sub‑agent transcript on demand (e.g., a collapsible “details” panel) without changing the main timeline contract.

## Validation Checklist

Frontend
- Trigger a prompt that invokes a sub‑agent.
- Expect exactly one card with robot icon and content `子 Agent 调用：<agentName>`.
- No sub‑agent partial/complete lines appear; only the main agent’s own text follows.

Backend
- Verify no `SUB_AGENT_PARTIAL/COMPLETE/ERROR` are sent.
- Verify no sub‑agent messages are written to `session_messages` (or equivalent table).
- Confirm tracing/billing entries include the sub‑agent run.

